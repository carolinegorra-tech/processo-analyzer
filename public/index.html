<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Processo Analyzer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Outfit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--cream:#faf6ee;--cream-dark:#f0ebe0;--ink:#1a1a1a;--ink-light:#4a4a4a;--ink-muted:#8a8578;--accent:#b8965a;--accent-hover:#a07d42;--accent-faint:rgba(184,150,90,0.08);--accent-border:rgba(184,150,90,0.25);--white:#ffffff;--shadow-sm:0 1px 3px rgba(0,0,0,0.04);--shadow-md:0 4px 20px rgba(0,0,0,0.06);--shadow-lg:0 12px 40px rgba(0,0,0,0.08);--radius:14px}
  *{margin:0;padding:0;box-sizing:border-box}
  body{min-height:100vh;background:var(--cream);font-family:'Outfit',sans-serif;color:var(--ink);-webkit-font-smoothing:antialiased}

  /* Subtle grain texture */
  body::after{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.5}

  /* Header */
  .header{position:sticky;top:0;z-index:100;padding:0 40px;height:64px;display:flex;align-items:center;justify-content:space-between;background:rgba(250,246,238,0.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(0,0,0,0.06)}
  .header-brand{display:flex;align-items:center;gap:12px}
  .header-dot{width:8px;height:8px;background:var(--accent);border-radius:50%}
  .header-title{font-family:'Playfair Display',serif;font-size:16px;font-weight:600;color:var(--ink);letter-spacing:-0.3px}
  .header-right{display:flex;align-items:center;gap:16px}
  .header-status{font-size:12px;color:var(--ink-muted);display:none;font-weight:300}
  .header-status.visible{display:block}
  .header-tag{font-size:9px;color:var(--accent);letter-spacing:2px;text-transform:uppercase;font-weight:500;padding:5px 12px;border:1px solid var(--accent-border);border-radius:100px}

  /* Container */
  .container{max-width:720px;margin:0 auto;padding:60px 24px 80px}

  /* Hero text */
  .hero{text-align:center;margin-bottom:48px}
  .hero h1{font-family:'Playfair Display',serif;font-size:38px;font-weight:700;color:var(--ink);letter-spacing:-1px;line-height:1.2;margin-bottom:12px}
  .hero h1 em{font-style:italic;color:var(--accent)}
  .hero p{font-size:14px;color:var(--ink-muted);font-weight:300;letter-spacing:0.3px}

  /* Upload */
  .upload-zone{border:2px dashed rgba(0,0,0,0.1);border-radius:var(--radius);padding:56px 40px;text-align:center;background:var(--white);cursor:pointer;transition:all 0.4s cubic-bezier(0.16,1,0.3,1);box-shadow:var(--shadow-sm)}
  .upload-zone:hover,.upload-zone.dragging{border-color:var(--accent);background:var(--accent-faint);box-shadow:var(--shadow-md)}
  .upload-icon-wrap{width:56px;height:56px;margin:0 auto 20px;background:var(--accent-faint);border-radius:14px;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
  .upload-zone:hover .upload-icon-wrap{background:rgba(184,150,90,0.15);transform:scale(1.05)}
  .upload-icon{font-size:22px}
  .upload-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--ink);margin-bottom:6px;font-weight:500}
  .upload-subtitle{font-size:13px;color:var(--ink-muted);font-weight:300}
  .upload-filename{font-size:11px;color:var(--accent);letter-spacing:1px;margin-top:20px;font-weight:400}
  .upload-footer{margin-top:20px;text-align:center;color:rgba(0,0,0,0.2);font-size:11px;letter-spacing:2px;text-transform:uppercase;font-weight:300}

  /* Chips */
  .chips{display:flex;justify-content:center;gap:8px;margin-top:20px;flex-wrap:wrap}
  .chip{font-size:10px;padding:5px 12px;border-radius:100px;background:var(--cream-dark);color:var(--ink-muted);font-weight:400;letter-spacing:0.5px}

  /* Button */
  .analyze-section{text-align:center;margin:36px 0}
  .analyze-btn{padding:16px 56px;background:var(--ink);border:none;border-radius:10px;color:var(--cream);font-size:13px;font-weight:500;letter-spacing:2px;text-transform:uppercase;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.3s;box-shadow:0 4px 16px rgba(0,0,0,0.12)}
  .analyze-btn:hover{background:#2a2a2a;transform:translateY(-1px);box-shadow:0 6px 24px rgba(0,0,0,0.16)}
  .analyze-btn:disabled{opacity:0.3;cursor:not-allowed;transform:none;box-shadow:none}

  /* Progress */
  .progress-section{text-align:center;margin:32px 0;padding:20px}
  .progress-track{width:100%;max-width:280px;margin:0 auto;height:3px;background:rgba(0,0,0,0.06);border-radius:10px;overflow:hidden}
  .progress-bar{height:100%;background:var(--accent);border-radius:10px;transition:width 0.6s cubic-bezier(0.16,1,0.3,1)}
  .progress-text{font-size:12px;color:var(--ink-muted);margin-top:14px;font-weight:300}
  .progress-spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--accent-border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Error */
  .error-box{background:rgba(200,60,60,0.06);border:1px solid rgba(200,60,60,0.15);border-radius:10px;padding:16px 20px;margin:16px 0;color:#b04040;font-size:13px;line-height:1.6;font-weight:300}

  /* Results */
  .results-section{margin-top:40px;animation:slideUp 0.5s cubic-bezier(0.16,1,0.3,1) both}
  .results-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .section-label{font-family:'Playfair Display',serif;font-size:20px;color:var(--ink);font-weight:600;letter-spacing:-0.3px}
  .export-btn{padding:8px 20px;background:var(--white);border:1px solid rgba(0,0,0,0.1);border-radius:8px;color:var(--ink-light);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;font-weight:400;display:flex;align-items:center;gap:6px}
  .export-btn:hover{border-color:rgba(0,0,0,0.2);box-shadow:var(--shadow-sm)}

  .results-wrap{background:var(--white);border:1px solid rgba(0,0,0,0.06);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-md)}
  .cat-row{padding:14px 28px;font-family:'Playfair Display',serif;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);font-weight:600;background:var(--accent-faint);border-bottom:1px solid rgba(0,0,0,0.04)}
  .data-row{display:flex;padding:14px 28px;gap:20px;border-bottom:1px solid rgba(0,0,0,0.03);transition:background 0.15s;animation:fadeRow 0.3s ease both}
  .data-row:hover{background:rgba(0,0,0,0.01)}
  .data-row:last-child{border-bottom:none}
  .data-label{min-width:200px;flex-shrink:0;font-size:12px;color:var(--ink-muted);font-weight:400;padding-top:1px}
  .data-value{font-size:14px;color:var(--ink);line-height:1.7;word-break:break-word;font-weight:400}
  .data-value.empty{color:rgba(0,0,0,0.2);font-style:italic;font-weight:300}

  /* Reset */
  .reset-section{margin-top:48px;text-align:center}
  .reset-btn{padding:10px 28px;background:transparent;border:1px solid rgba(0,0,0,0.1);border-radius:8px;color:var(--ink-muted);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;font-weight:300}
  .reset-btn:hover{border-color:rgba(0,0,0,0.2);color:var(--ink)}

  .footer-note{text-align:center;font-size:10px;color:rgba(0,0,0,0.2);margin-top:40px;letter-spacing:1px;font-weight:300}

  .hidden{display:none!important}

  @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fadeRow{from{opacity:0}to{opacity:1}}

  @media(max-width:600px){
    .header{padding:0 18px;height:56px}
    .hero h1{font-size:28px}
    .container{padding:40px 16px 60px}
    .upload-zone{padding:40px 20px}
    .data-row{flex-direction:column;gap:4px;padding:12px 20px}
    .data-label{min-width:unset}
    .cat-row{padding:12px 20px}
    .chips{gap:6px}
  }
</style>
</head>
<body>
<div class="header">
  <div class="header-brand">
    <div class="header-dot"></div>
    <div class="header-title">Processo Analyzer</div>
  </div>
  <div class="header-right">
    <div class="header-status" id="headerStatus"></div>
    <div class="header-tag">Claude AI</div>
  </div>
</div>
<div class="container">
  <div class="hero" id="heroSection">
    <h1>An√°lise de processos<br>com <em>intelig√™ncia</em></h1>
    <p>Extraia 34 campos automaticamente de qualquer PDF trabalhista</p>
  </div>
  <div id="uploadZone" class="upload-zone" ondragover="event.preventDefault();this.classList.add('dragging')" ondragleave="this.classList.remove('dragging')" ondrop="handleDrop(event)" onclick="document.getElementById('fileInput').click()">
    <div class="upload-icon-wrap"><div class="upload-icon">üìÑ</div></div>
    <div class="upload-title">Carregar PDF</div>
    <div class="upload-subtitle">Arraste aqui ou clique para selecionar</div>
    <div class="upload-filename" id="fileName"></div>
    <input id="fileInput" type="file" accept=".pdf" onchange="handleFile(event)" style="display:none">
  </div>
  <div id="uploadFooter" class="chips">
    <span class="chip">Senten√ßa</span>
    <span class="chip">TRT</span>
    <span class="chip">TST</span>
    <span class="chip">Execu√ß√£o</span>
    <span class="chip">Partes</span>
    <span class="chip">Audi√™ncia</span>
  </div>
  <div id="analyzeSection" class="analyze-section hidden"><button class="analyze-btn" id="analyzeBtn" onclick="analyze()">Analisar Processo</button></div>
  <div id="progressSection" class="progress-section hidden"><div class="progress-track"><div class="progress-bar" id="progressBar" style="width:0%"></div></div><div class="progress-text" id="progressText"></div></div>
  <div id="errorBox" class="error-box hidden"></div>
  <div id="resultsSection" class="results-section hidden">
    <div class="results-header">
      <div class="section-label">Resultado</div>
      <button class="export-btn" onclick="exportCSV()"><span>‚Üì</span> Exportar CSV</button>
    </div>
    <div class="results-wrap" id="resultsWrap"></div>
  </div>
  <div id="resetSection" class="reset-section hidden"><button class="reset-btn" onclick="resetAll()">Analisar outro processo</button></div>
  <div id="footerNote" class="footer-note hidden"></div>
</div>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

var FIELDS=[
  {cat:"Dados do Processo"},
  {key:"numero_processo",label:"1. N√∫mero do processo"},
  {key:"status_processo",label:"2. Status do processo"},
  {key:"data_arquivamento",label:"3. Data do arquivamento"},
  {cat:"Partes"},
  {key:"nome_reclamante",label:"4. Nome do reclamante"},
  {key:"patrono_reclamante",label:"5. Patrono do reclamante"},
  {key:"reclamadas",label:"6. Reclamadas"},
  {cat:"Jurisdi√ß√£o"},
  {key:"comarca",label:"7. Comarca"},
  {key:"vara",label:"8. Vara"},
  {key:"nome_juiz",label:"9. Nome do Juiz"},
  {key:"turma_trt",label:"10. Turma TRT"},
  {key:"turma_tst",label:"11. Turma TST"},
  {cat:"Detalhes da A√ß√£o"},
  {key:"valor_causa",label:"12. Valor da causa"},
  {key:"pedidos_inicial",label:"13. Pedidos da inicial"},
  {key:"data_admissao",label:"14. Data de admiss√£o"},
  {key:"data_demissao",label:"15. Data de demiss√£o"},
  {cat:"Audi√™ncia"},
  {key:"data_audiencia",label:"16. Data da audi√™ncia"},
  {key:"tipo_audiencia",label:"17. Tipo de audi√™ncia"},
  {key:"testemunhas_reclamada",label:"18. Testemunhas da reclamada"},
  {key:"testemunhas_reclamante",label:"19. Testemunhas do reclamante"},
  {cat:"Fase e Senten√ßa"},
  {key:"fase_atual",label:"20. Fase atual"},
  {key:"sentenca",label:"21. Senten√ßa"},
  {key:"sentenca_enquadramento",label:"22. Senten√ßa ‚Äî enquadramento?"},
  {key:"sentenca_jornada_externa",label:"23. Senten√ßa ‚Äî jornada externa?"},
  {cat:"TRT"},
  {key:"resumo_trt",label:"24. Resumo do TRT"},
  {key:"acordao_trt_enquadramento",label:"25. Ac√≥rd√£o TRT ‚Äî enquadramento?"},
  {key:"acordao_trt_jornada_externa",label:"26. Ac√≥rd√£o TRT ‚Äî jornada externa?"},
  {key:"sustentacao_oral",label:"27. Sustenta√ß√£o oral?"},
  {cat:"TST"},
  {key:"acordao_tst",label:"28. Ac√≥rd√£o TST"},
  {key:"acordao_tst_enquadramento",label:"29. Ac√≥rd√£o TST ‚Äî enquadramento?"},
  {key:"acordao_tst_jornada_externa",label:"30. Ac√≥rd√£o TST ‚Äî jornada externa?"},
  {cat:"Andamento e Execu√ß√£o"},
  {key:"data_ultimo_andamento",label:"31. Data do √∫ltimo andamento"},
  {key:"resumo_ultimo_andamento",label:"32. Resumo do √∫ltimo andamento"},
  {key:"numero_execucao_provisoria",label:"33. N¬∫ execu√ß√£o provis√≥ria"},
  {key:"valor_homologado_execucao",label:"34. Valor homologado na execu√ß√£o"}
];

var SYSTEM_PROMPT = "O Agente analisar√° o texto extra√≠do do PDF. Utilize sempre o modo de alto esfor√ßo. O n√∫mero do processo √© o que consta na nomea√ß√£o do arquivo, sendo assim, sempre que for inserir qualquer informa√ß√£o confira se o n√∫mero da pe√ßa/decis√£o/senten√ßa/acord√£o bate com o n√∫mero do arquivo. Ignore provas emprestadas de outros processos juntados com a peti√ß√£o. N√£o utilize informa√ß√µes de \"provas emprestadas\", inicial, contesta√ß√£o, ac√≥rd√£os, decis√µes interlocut√≥rias, ou quaisquer documentos diversos da senten√ßa do processo original. Valida√ß√£o de partes: confirme que o(a) autor(a)/reclamante indicado(a) na senten√ßa coincide com o(a) autor(a)/reclamante da peti√ß√£o inicial dos autos.\n\nColunas:\n\n1. numero_processo: Formato CNJ: NNNNNNN-DD.AAAA.JTR.OOOO.\n\n2. status_processo: Arquivado: quando houver arquivamento por certid√£o do pr√≥prio ju√≠zo. Analise apenas despachos, decis√µes e certid√µes do ju√≠zo. Certid√£o de tr√¢nsito em julgado N√ÉO SIGNIFICA ARQUIVADO. Se n√£o houver, indique \"Ativo\".\n\n3. data_arquivamento: DD/MM/AAAA. Necessariamente haver√° a palavra arquivamento na certid√£o do ju√≠zo ou despacho. N√£o considere certid√£o de decurso de prazo. N√£o considere documentos das partes, peti√ß√µes, anexos ou sum√°rio. Procure apenas em despachos, decis√µes e certid√µes do ju√≠zo. Ignore o √≠ndice. N√£o invente informa√ß√µes. Certid√£o de tr√¢nsito em julgado N√ÉO √â DE ARQUIVAMENTO.\n\n4. nome_reclamante: Nome completo, consta na capa do processo ou topo das decis√µes.\n\n5. patrono_reclamante: Advogado do reclamante, consta na capa. N√£o confundir com reclamante. Sem abreviar. Se n√£o houver capa, ver final das peti√ß√µes do reclamante. M√∫ltiplos: separar por \";\".\n\n6. reclamadas: Nome completo das reclamadas. Campo \"RECLAMADO: XXX\" na capa. Raz√£o social completa. EM LETRAS MAI√öSCULAS.\n\n7. comarca: Por extenso. Ex: S√£o Paulo.\n\n8. vara: Por extenso. Ex: 4¬™ Vara do Trabalho de Campinas/SP.\n\n9. nome_juiz: Sem abrevia√ß√µes. Usar √∫ltimo despacho ou ata de audi√™ncia.\n\n10. turma_trt: Ex: 1¬™ Turma do Tribunal Regional da 15¬™ Regi√£o.\n\n11. turma_tst: Ex: 1¬™ Turma do Tribunal Superior do Trabalho.\n\n12. valor_causa: R$ XXXXX,XX.\n\n13. pedidos_inicial: Termos nucleares da se√ß√£o \"Pedidos\"/\"Requerimentos\". Ex: \"Enquadramento sindical; Horas extras\". Sem justi√ßa gratuita, honor√°rios.\n\n14. data_admissao: DD/MM/AAAA. PRIORIZE a data que consta na SENTENCA. Se nao houver na sentenca, use TRCT ou docs oficiais.\n\n15. data_demissao: DD/MM/AAAA. PRIORIZE SEMPRE a data que consta na SENTENCA. Se houver datas diferentes na peticao inicial e na sentenca, use a da SENTENCA. A data de demissao DEVE ser POSTERIOR a data de admissao.\n\n16. data_audiencia: Datas de audi√™ncias futuras. DD/MM/AAAA.\n\n17. tipo_audiencia: \"Inicial\", \"UNA\", \"Instru√ß√£o\" ou \"Concilia√ß√£o\".\n\n18. testemunhas_reclamada: Nomes E CPF das testemunhas da reclamada ouvidas. Ata de Audi√™ncia, se√ß√£o \"qualifica√ß√£o\". M√∫ltiplas: \";\".\n\n19. testemunhas_reclamante: Idem para testemunhas do reclamante.\n\n20. fase_atual: Conhecimento / Recursal / Execu√ß√£o / Suspenso / Arquivado.\n\n21. sentenca: Procedentes e Improcedentes. N√£o usar \"provas emprestadas\". Validar partes.\n\n22. sentenca_enquadramento: \"sim\" se deferiu enquadramento financeiro; \"n√£o\" se indeferiu; \"n/a\" se n√£o existiu pedido. Fonte: senten√ßa de 1¬∫ grau. Ignorar docs de outros processos.\n\n23. sentenca_jornada_externa: \"sim\" se reconheceu jornada externa e horas extras improcedente; \"n√£o\" se n√£o reconheceu. Fonte: senten√ßa de 1¬∫ grau.\n\n24. resumo_trt: 1‚Äì2 frases. Mantida ou reformada e o qu√™.\n\n25. acordao_trt_enquadramento: \"sim\"/\"n√£o\"/\"n/a\". Fonte: ac√≥rd√£o de 2¬∫ grau.\n\n26. acordao_trt_jornada_externa: \"sim\"/\"n√£o\". Fonte: AC√ìRD√ÉO DO 2¬∫ GRAU.\n\n27. sustentacao_oral: \"Sim\" ou \"N√£o\". Final do ac√≥rd√£o.\n\n28. acordao_tst: 1‚Äì2 frases do resultado no TST.\n\n29. acordao_tst_enquadramento: \"sim\"/\"n√£o\"/\"n/a\". Fonte: ac√≥rd√£o de 3¬∫ grau.\n\n30. acordao_tst_jornada_externa: \"sim\"/\"n√£o\". Fonte: AC√ìRD√ÉO do pr√≥prio processo.\n\n31. data_ultimo_andamento: DD/MM/AAAA da √∫ltima movimenta√ß√£o.\n\n32. resumo_ultimo_andamento: Breve resumo do √∫ltimo andamento.\n\n33. numero_execucao_provisoria: Formato CNJ ou \"N/A\".\n\n34. valor_homologado_execucao: Valor homologado ou \"N/A\".\n\nRESPONDA APENAS COM JSON V√ÅLIDO contendo as 34 chaves. Sem markdown, sem backticks, sem explica√ß√µes.";

var currentFile=null,fileBuffer=null,analysisResults=null;
function $(id){return document.getElementById(id)}
function show(el){el.classList.remove('hidden')}
function hide(el){el.classList.add('hidden')}
function isEmpty(v){return !v||v==='N/A'||v==='n/a'}

function handleDrop(e){e.preventDefault();$('uploadZone').classList.remove('dragging');if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])}
function handleFile(e){if(e.target.files[0])loadFile(e.target.files[0])}

function loadFile(f){
  if(!f||f.type!=='application/pdf'){showError('Selecione um arquivo PDF.');return}
  currentFile=f;hide($('errorBox'));hide($('resultsSection'));analysisResults=null;
  $('fileName').textContent=f.name+' ¬∑ '+(f.size/1024/1024).toFixed(1)+' MB';
  $('uploadZone').style.borderColor='var(--accent)';$('uploadZone').style.borderStyle='solid';
  $('headerStatus').textContent=f.name;$('headerStatus').classList.add('visible');
  show($('analyzeSection'));show($('resetSection'));hide($('uploadFooter'));
  $('heroSection').style.display='none';
  var r=new FileReader();
  r.onload=function(){fileBuffer=r.result};
  r.readAsArrayBuffer(f);
}

function showError(msg){$('errorBox').textContent=msg;show($('errorBox'))}
function setProgress(pct,msg){$('progressBar').style.width=pct+'%';$('progressText').innerHTML='<span class="progress-spinner"></span>'+msg}

async function extractText(buf){
  var pdf=await pdfjsLib.getDocument({data:buf}).promise;
  var pages=[];
  for(var i=1;i<=pdf.numPages;i++){
    var pg=await pdf.getPage(i);
    var c=await pg.getTextContent();
    pages.push(c.items.map(function(x){return x.str}).join(' '));
    if(i%20===0) setProgress(10+Math.round((i/pdf.numPages)*25),'Extraindo texto ¬∑ p√°gina '+i+'/'+pdf.numPages);
  }
  return{pages:pages,total:pdf.numPages};
}

async function analyze(){
  if(!fileBuffer)return;
  var btn=$('analyzeBtn');btn.disabled=true;btn.textContent='ANALISANDO...';
  hide($('errorBox'));hide($('resultsSection'));show($('progressSection'));
  setProgress(5,'Preparando...');

  try{
    setProgress(10,'Lendo PDF...');
    var bufCopy=fileBuffer.slice(0);
    var result=await extractText(bufCopy);
    var pages=result.pages;var total=result.total;

    var fullText=pages.join('').trim();
    if(fullText.length<50)throw new Error('PDF sem texto extra√≠vel. Pode precisar de OCR.');

    setProgress(35,'Organizando texto...');

    var text='';
    for(var j=0;j<pages.length;j++){if(pages[j].trim())text+='--- P√ÅG '+(j+1)+'/'+total+' ---\n'+pages[j]+'\n\n'}

    if(text.length>350000) text=text.substring(0,350000)+'\n[TRUNCADO - PDF muito grande]';

    setProgress(45,'Claude est√° analisando o processo...');

    var resp=await fetch('/api/analyze',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        system:SYSTEM_PROMPT,
        fileName:currentFile.name,
        text:text
      })
    });

    setProgress(85,'Processando resposta...');
    if(!resp.ok){
      var errData;
      try{errData=await resp.json()}catch(e){errData={error:'Erro '+resp.status}}
      throw new Error(errData.error?.message||errData.error||'Erro '+resp.status);
    }
    var data=await resp.json();
    var raw=data.content.map(function(c){return c.text||''}).join('');
    var parsed;
    try{parsed=JSON.parse(raw.replace(/```json\s*/g,'').replace(/```/g,'').trim())}
    catch(ex){var m=raw.match(/\{[\s\S]*\}/);parsed=m?JSON.parse(m[0]):null}
    if(!parsed)throw new Error('Resposta inv√°lida do Claude.');

    analysisResults=parsed;setProgress(100,'Conclu√≠do!');
    renderResults(parsed);show($('resultsSection'));
    $('headerStatus').textContent='An√°lise conclu√≠da ¬∑ '+total+' p√°gs';
    $('footerNote').textContent='An√°lise por Claude AI ¬∑ '+new Date().toLocaleDateString('pt-BR');show($('footerNote'));
    setTimeout(function(){$('resultsSection').scrollIntoView({behavior:'smooth',block:'start'})},300);
  }catch(err){showError(err.message)}
  finally{hide($('progressSection'));btn.disabled=false;btn.textContent='ANALISAR PROCESSO'}
}

function renderResults(data){
  var wrap=$('resultsWrap');wrap.innerHTML='';
  FIELDS.forEach(function(field,i){
    var div=document.createElement('div');
    if(field.cat){div.className='cat-row';div.textContent=field.cat}
    else{var val=data[field.key]||'N/A';var empty=isEmpty(val);div.className='data-row';div.style.animationDelay=(i*0.02)+'s';div.innerHTML='<div class="data-label">'+field.label+'</div><div class="data-value'+(empty?' empty':'')+'">' +escapeHtml(val)+'</div>'}
    wrap.appendChild(div);
  });
}

function exportCSV(){
  if(!analysisResults)return;
  var rows=FIELDS.filter(function(f){return f.key}).map(function(f){return '"'+f.label+'","'+(analysisResults[f.key]||'N/A').replace(/"/g,'""')+'"'});
  var blob=new Blob(['\uFEFF'+'Campo,Valor\n'+rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='analise_'+(currentFile?currentFile.name.replace('.pdf',''):'processo')+'.csv';a.click();
}

function resetAll(){
  currentFile=null;fileBuffer=null;analysisResults=null;
  show($('uploadZone'));show($('uploadFooter'));
  hide($('analyzeSection'));hide($('resultsSection'));hide($('resetSection'));hide($('footerNote'));hide($('errorBox'));
  $('headerStatus').classList.remove('visible');$('uploadZone').style.borderColor='';$('uploadZone').style.borderStyle='dashed';
  $('fileName').textContent='';$('fileInput').value='';
  $('heroSection').style.display='';
}

function escapeHtml(str){var div=document.createElement('div');div.textContent=String(str);return div.innerHTML}
</script>
</body>
</html>
