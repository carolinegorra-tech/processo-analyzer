
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Processo Analyzer ‚Äî Extra√ß√£o com IA</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&display=swap');
  :root{--gold:#c8aa64;--gold-faint:rgba(200,170,100,0.3);--gold-dim:rgba(200,170,100,0.6);--bg-deep:#0a0f1e;--bg-mid:#0d1f3c;--text:#e8e4d9;--text-light:#f0ead0}
  *{margin:0;padding:0;box-sizing:border-box}
  body{min-height:100vh;background:linear-gradient(135deg,var(--bg-deep) 0%,var(--bg-mid) 50%,#0a1628 100%);font-family:'Crimson Text',Georgia,serif;color:var(--text)}
  .header{border-bottom:1px solid var(--gold-faint);padding:22px 36px;display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.3)}
  .header-label{font-size:10px;letter-spacing:4px;color:var(--gold);text-transform:uppercase;margin-bottom:3px}
  .header-title{font-size:20px;font-weight:bold;color:var(--text-light)}
  .header-right{text-align:right}
  .header-status{font-size:12px;color:rgba(200,170,100,0.8);margin-bottom:2px;display:none}
  .header-status.visible{display:block}
  .header-legal{font-size:10px;color:rgba(200,170,100,0.4)}
  .container{max-width:820px;margin:0 auto;padding:40px 24px}
  .upload-zone{border:2px dashed var(--gold-faint);border-radius:12px;padding:60px 40px;text-align:center;background:rgba(255,255,255,0.02);cursor:pointer;transition:all 0.2s}
  .upload-zone:hover,.upload-zone.dragging{border-color:var(--gold);background:rgba(200,170,100,0.05)}
  .upload-icon{font-size:48px;margin-bottom:16px}
  .upload-title{font-size:18px;color:var(--gold);margin-bottom:8px}
  .upload-subtitle{font-size:13px;color:rgba(255,255,255,0.4);margin-bottom:20px}
  .upload-filename{font-size:11px;color:rgba(200,170,100,0.4);letter-spacing:1px}
  .upload-footer{margin-top:32px;text-align:center;color:rgba(255,255,255,0.15);font-size:11px;letter-spacing:2px}
  .analyze-section{text-align:center;margin:28px 0}
  .analyze-btn{padding:14px 40px;background:var(--gold);border:none;border-radius:4px;color:var(--bg-deep);font-size:14px;font-weight:bold;letter-spacing:2px;text-transform:uppercase;cursor:pointer;font-family:'Crimson Text',Georgia,serif;transition:filter 0.2s}
  .analyze-btn:hover{filter:brightness(1.1)}
  .analyze-btn:disabled{opacity:0.4;cursor:not-allowed;filter:none}
  .progress-section{text-align:center;margin:20px 0}
  .progress-track{width:100%;max-width:400px;margin:0 auto;height:3px;background:rgba(255,255,255,0.1);border-radius:10px;overflow:hidden}
  .progress-bar{height:100%;background:var(--gold);border-radius:10px;transition:width 0.5s ease}
  .progress-text{font-size:12px;color:var(--gold-dim);margin-top:8px}
  .error-box{background:rgba(200,60,60,0.15);border:1px solid rgba(200,60,60,0.3);border-radius:6px;padding:14px 18px;margin:16px 0;color:#e06060;font-size:14px;line-height:1.5}
  .section-label{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:14px}
  .results-section{margin-top:30px}
  .results-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .export-btn{padding:7px 16px;background:transparent;border:1px solid var(--gold-faint);border-radius:4px;color:var(--gold);font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;font-family:'Crimson Text',Georgia,serif;transition:all 0.2s}
  .export-btn:hover{border-color:var(--gold);background:rgba(200,170,100,0.08)}
  .cat-row{padding:10px 20px;margin-top:16px;margin-bottom:4px;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);font-weight:bold;border-bottom:1px solid var(--gold-faint)}
  .cat-row:first-child{margin-top:0}
  .data-row{display:flex;padding:10px 20px;gap:16px;border-bottom:1px solid rgba(255,255,255,0.04);animation:cardIn 0.2s ease both}
  .data-row:hover{background:rgba(255,255,255,0.02)}
  .data-label{min-width:220px;flex-shrink:0;font-size:13px;color:var(--gold-dim)}
  .data-value{font-size:14px;color:var(--text-light);line-height:1.5;word-break:break-word}
  .data-value.empty{color:rgba(255,255,255,0.2);font-style:italic}
  @keyframes cardIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .results-wrap{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;overflow:hidden}
  .reset-section{margin-top:40px;text-align:center}
  .reset-btn{padding:8px 20px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:rgba(255,255,255,0.3);font-size:11px;letter-spacing:1px;cursor:pointer;font-family:'Crimson Text',Georgia,serif;transition:all 0.2s}
  .reset-btn:hover{border-color:rgba(255,255,255,0.25);color:rgba(255,255,255,0.5)}
  .footer-note{text-align:center;font-size:10px;color:rgba(255,255,255,0.15);margin-top:30px;letter-spacing:1px}
  .hidden{display:none!important}
  @media(max-width:600px){.header{padding:16px 20px}.container{padding:24px 16px}.data-row{flex-direction:column;gap:2px}.data-label{min-width:unset}}
</style>
</head>
<body>
<div class="header">
  <div>
    <div class="header-label">An√°lise com IA</div>
    <div class="header-title">Processo Analyzer ‚Äî Trabalhista</div>
  </div>
  <div class="header-right">
    <div class="header-status" id="headerStatus"></div>
    <div class="header-legal">Powered by Claude AI</div>
  </div>
</div>
<div class="container">
  <div id="uploadZone" class="upload-zone" ondragover="event.preventDefault();this.classList.add('dragging')" ondragleave="this.classList.remove('dragging')" ondrop="handleDrop(event)" onclick="document.getElementById('fileInput').click()">
    <div class="upload-icon">üìÑ</div>
    <div class="upload-title">Carregar PDF do Processo</div>
    <div class="upload-subtitle">Arraste o arquivo aqui ou clique para selecionar</div>
    <div class="upload-filename" id="fileName">Aceita qualquer PDF trabalhista ‚Äî qualquer tamanho</div>
    <input id="fileInput" type="file" accept=".pdf" onchange="handleFile(event)" style="display:none">
  </div>
  <div id="uploadFooter" class="upload-footer">34 campos extra√≠dos automaticamente ¬∑ Senten√ßa ¬∑ TRT ¬∑ TST ¬∑ Execu√ß√£o</div>
  <div id="analyzeSection" class="analyze-section hidden"><button class="analyze-btn" id="analyzeBtn" onclick="analyze()">Analisar Processo</button></div>
  <div id="progressSection" class="progress-section hidden"><div class="progress-track"><div class="progress-bar" id="progressBar" style="width:0%"></div></div><div class="progress-text" id="progressText"></div></div>
  <div id="errorBox" class="error-box hidden"></div>
  <div id="resultsSection" class="results-section hidden">
    <div class="results-header"><div class="section-label">Resultado da An√°lise</div><button class="export-btn" onclick="exportCSV()">‚¨á Exportar CSV</button></div>
    <div class="results-wrap" id="resultsWrap"></div>
  </div>
  <div id="resetSection" class="reset-section hidden"><button class="reset-btn" onclick="resetAll()">Carregar outro arquivo</button></div>
  <div id="footerNote" class="footer-note hidden"></div>
</div>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

var FIELDS=[
  {cat:"Dados do Processo"},
  {key:"numero_processo",label:"1. N√∫mero do processo"},
  {key:"status_processo",label:"2. Status do processo"},
  {key:"data_arquivamento",label:"3. Data do arquivamento"},
  {cat:"Partes"},
  {key:"nome_reclamante",label:"4. Nome do reclamante"},
  {key:"patrono_reclamante",label:"5. Patrono do reclamante"},
  {key:"reclamadas",label:"6. Reclamadas"},
  {cat:"Jurisdi√ß√£o"},
  {key:"comarca",label:"7. Comarca"},
  {key:"vara",label:"8. Vara"},
  {key:"nome_juiz",label:"9. Nome do Juiz"},
  {key:"turma_trt",label:"10. Turma TRT"},
  {key:"turma_tst",label:"11. Turma TST"},
  {cat:"Detalhes da A√ß√£o"},
  {key:"valor_causa",label:"12. Valor da causa"},
  {key:"pedidos_inicial",label:"13. Pedidos da inicial"},
  {key:"data_admissao",label:"14. Data de admiss√£o"},
  {key:"data_demissao",label:"15. Data de demiss√£o"},
  {cat:"Audi√™ncia"},
  {key:"data_audiencia",label:"16. Data da audi√™ncia"},
  {key:"tipo_audiencia",label:"17. Tipo de audi√™ncia"},
  {key:"testemunhas_reclamada",label:"18. Testemunhas da reclamada"},
  {key:"testemunhas_reclamante",label:"19. Testemunhas do reclamante"},
  {cat:"Fase e Senten√ßa"},
  {key:"fase_atual",label:"20. Fase atual"},
  {key:"sentenca",label:"21. Senten√ßa"},
  {key:"sentenca_enquadramento",label:"22. Senten√ßa ‚Äî enquadramento?"},
  {key:"sentenca_jornada_externa",label:"23. Senten√ßa ‚Äî jornada externa?"},
  {cat:"TRT"},
  {key:"resumo_trt",label:"24. Resumo do TRT"},
  {key:"acordao_trt_enquadramento",label:"25. Ac√≥rd√£o TRT ‚Äî enquadramento?"},
  {key:"acordao_trt_jornada_externa",label:"26. Ac√≥rd√£o TRT ‚Äî jornada externa?"},
  {key:"sustentacao_oral",label:"27. Sustenta√ß√£o oral?"},
  {cat:"TST"},
  {key:"acordao_tst",label:"28. Ac√≥rd√£o TST"},
  {key:"acordao_tst_enquadramento",label:"29. Ac√≥rd√£o TST ‚Äî enquadramento?"},
  {key:"acordao_tst_jornada_externa",label:"30. Ac√≥rd√£o TST ‚Äî jornada externa?"},
  {cat:"Andamento e Execu√ß√£o"},
  {key:"data_ultimo_andamento",label:"31. Data do √∫ltimo andamento"},
  {key:"resumo_ultimo_andamento",label:"32. Resumo do √∫ltimo andamento"},
  {key:"numero_execucao_provisoria",label:"33. N¬∫ execu√ß√£o provis√≥ria"},
  {key:"valor_homologado_execucao",label:"34. Valor homologado na execu√ß√£o"}
];

var SYSTEM_PROMPT = "O Agente analisar√° o texto extra√≠do do PDF. Utilize sempre o modo de alto esfor√ßo. O n√∫mero do processo √© o que consta na nomea√ß√£o do arquivo, sendo assim, sempre que for inserir qualquer informa√ß√£o confira se o n√∫mero da pe√ßa/decis√£o/senten√ßa/acord√£o bate com o n√∫mero do arquivo. Ignore provas emprestadas de outros processos juntados com a peti√ß√£o. N√£o utilize informa√ß√µes de \"provas emprestadas\", inicial, contesta√ß√£o, ac√≥rd√£os, decis√µes interlocut√≥rias, ou quaisquer documentos diversos da senten√ßa do processo original. Valida√ß√£o de partes: confirme que o(a) autor(a)/reclamante indicado(a) na senten√ßa coincide com o(a) autor(a)/reclamante da peti√ß√£o inicial dos autos.\n\nColunas:\n\n1. numero_processo: Formato CNJ: NNNNNNN-DD.AAAA.JTR.OOOO.\n\n2. status_processo: Arquivado: quando houver arquivamento por certid√£o do pr√≥prio ju√≠zo. Analise apenas despachos, decis√µes e certid√µes do ju√≠zo. Certid√£o de tr√¢nsito em julgado N√ÉO SIGNIFICA ARQUIVADO. Se n√£o houver, indique \"Ativo\".\n\n3. data_arquivamento: DD/MM/AAAA. Necessariamente haver√° a palavra arquivamento na certid√£o do ju√≠zo ou despacho. N√£o considere certid√£o de decurso de prazo. N√£o considere documentos das partes, peti√ß√µes, anexos ou sum√°rio. Procure apenas em despachos, decis√µes e certid√µes do ju√≠zo. Ignore o √≠ndice. N√£o invente informa√ß√µes. Certid√£o de tr√¢nsito em julgado N√ÉO √â DE ARQUIVAMENTO.\n\n4. nome_reclamante: Nome completo, consta na capa do processo ou topo das decis√µes.\n\n5. patrono_reclamante: Advogado do reclamante, consta na capa. N√£o confundir com reclamante. Sem abreviar. Se n√£o houver capa, ver final das peti√ß√µes do reclamante. M√∫ltiplos: separar por \";\".\n\n6. reclamadas: Nome completo das reclamadas. Campo \"RECLAMADO: XXX\" na capa. Raz√£o social completa. EM LETRAS MAI√öSCULAS.\n\n7. comarca: Por extenso. Ex: S√£o Paulo.\n\n8. vara: Por extenso. Ex: 4¬™ Vara do Trabalho de Campinas/SP.\n\n9. nome_juiz: Sem abrevia√ß√µes. Usar √∫ltimo despacho ou ata de audi√™ncia.\n\n10. turma_trt: Ex: 1¬™ Turma do Tribunal Regional da 15¬™ Regi√£o.\n\n11. turma_tst: Ex: 1¬™ Turma do Tribunal Superior do Trabalho.\n\n12. valor_causa: R$ XXXXX,XX.\n\n13. pedidos_inicial: Termos nucleares da se√ß√£o \"Pedidos\"/\"Requerimentos\". Ex: \"Enquadramento sindical; Horas extras\". Sem justi√ßa gratuita, honor√°rios.\n\n14. data_admissao: DD/MM/AAAA se constar em senten√ßa, TRCT ou docs oficiais.\n\n15. data_demissao: DD/MM/AAAA se constar em senten√ßa, TRCT ou docs oficiais.\n\n16. data_audiencia: Datas de audi√™ncias futuras. DD/MM/AAAA.\n\n17. tipo_audiencia: \"Inicial\", \"UNA\", \"Instru√ß√£o\" ou \"Concilia√ß√£o\".\n\n18. testemunhas_reclamada: Nomes E CPF das testemunhas da reclamada ouvidas. Ata de Audi√™ncia, se√ß√£o \"qualifica√ß√£o\". M√∫ltiplas: \";\".\n\n19. testemunhas_reclamante: Idem para testemunhas do reclamante.\n\n20. fase_atual: Conhecimento / Recursal / Execu√ß√£o / Suspenso / Arquivado.\n\n21. sentenca: Procedentes e Improcedentes. N√£o usar \"provas emprestadas\". Validar partes.\n\n22. sentenca_enquadramento: \"sim\" se deferiu enquadramento financeiro; \"n√£o\" se indeferiu; \"n/a\" se n√£o existiu pedido. Fonte: senten√ßa de 1¬∫ grau. Ignorar docs de outros processos.\n\n23. sentenca_jornada_externa: \"sim\" se reconheceu jornada externa e horas extras improcedente; \"n√£o\" se n√£o reconheceu. Fonte: senten√ßa de 1¬∫ grau.\n\n24. resumo_trt: 1‚Äì2 frases. Mantida ou reformada e o qu√™.\n\n25. acordao_trt_enquadramento: \"sim\"/\"n√£o\"/\"n/a\". Fonte: ac√≥rd√£o de 2¬∫ grau.\n\n26. acordao_trt_jornada_externa: \"sim\"/\"n√£o\". Fonte: AC√ìRD√ÉO DO 2¬∫ GRAU.\n\n27. sustentacao_oral: \"Sim\" ou \"N√£o\". Final do ac√≥rd√£o.\n\n28. acordao_tst: 1‚Äì2 frases do resultado no TST.\n\n29. acordao_tst_enquadramento: \"sim\"/\"n√£o\"/\"n/a\". Fonte: ac√≥rd√£o de 3¬∫ grau.\n\n30. acordao_tst_jornada_externa: \"sim\"/\"n√£o\". Fonte: AC√ìRD√ÉO do pr√≥prio processo.\n\n31. data_ultimo_andamento: DD/MM/AAAA da √∫ltima movimenta√ß√£o.\n\n32. resumo_ultimo_andamento: Breve resumo do √∫ltimo andamento.\n\n33. numero_execucao_provisoria: Formato CNJ ou \"N/A\".\n\n34. valor_homologado_execucao: Valor homologado ou \"N/A\".\n\nRESPONDA APENAS COM JSON V√ÅLIDO contendo as 34 chaves. Sem markdown, sem backticks, sem explica√ß√µes.";

var currentFile=null,fileBuffer=null,analysisResults=null;
function $(id){return document.getElementById(id)}
function show(el){el.classList.remove('hidden')}
function hide(el){el.classList.add('hidden')}
function isEmpty(v){return !v||v==='N/A'||v==='n/a'}

function handleDrop(e){e.preventDefault();$('uploadZone').classList.remove('dragging');if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])}
function handleFile(e){if(e.target.files[0])loadFile(e.target.files[0])}

function loadFile(f){
  if(!f||f.type!=='application/pdf'){showError('Selecione um arquivo PDF.');return}
  currentFile=f;hide($('errorBox'));hide($('resultsSection'));analysisResults=null;
  $('fileName').textContent=f.name+' ('+(f.size/1024/1024).toFixed(2)+' MB)';
  $('uploadZone').style.borderColor='var(--gold)';
  $('headerStatus').textContent='üìÑ '+f.name;$('headerStatus').classList.add('visible');
  show($('analyzeSection'));show($('resetSection'));hide($('uploadFooter'));
  var r=new FileReader();
  r.onload=function(){fileBuffer=r.result};
  r.readAsArrayBuffer(f);
}

function showError(msg){$('errorBox').textContent=msg;show($('errorBox'))}
function setProgress(pct,msg){$('progressBar').style.width=pct+'%';$('progressText').textContent=msg}

async function extractText(buf){
  var pdf=await pdfjsLib.getDocument({data:buf}).promise;
  var pages=[];
  for(var i=1;i<=pdf.numPages;i++){
    var pg=await pdf.getPage(i);
    var c=await pg.getTextContent();
    pages.push(c.items.map(function(x){return x.str}).join(' '));
    if(i%20===0) setProgress(10+Math.round((i/pdf.numPages)*25),'Extraindo p√°gina '+i+' de '+pdf.numPages+'...');
  }
  return{pages:pages,total:pdf.numPages};
}

async function analyze(){
  if(!fileBuffer)return;
  var btn=$('analyzeBtn');btn.disabled=true;btn.textContent='ANALISANDO...';
  hide($('errorBox'));hide($('resultsSection'));show($('progressSection'));
  setProgress(5,'Iniciando extra√ß√£o de texto...');

  try{
    setProgress(10,'Extraindo texto do PDF (pode levar uns segundos)...');
    var result=await extractText(fileBuffer);
    var pages=result.pages;var total=result.total;

    var fullText=pages.join('').trim();
    if(fullText.length<50)throw new Error('PDF sem texto extra√≠vel. Pode precisar de OCR.');

    setProgress(35,'Preparando texto para an√°lise...');

    // Build text in normal order only (to maximize content within limit)
    var text='';
    for(var j=0;j<pages.length;j++){if(pages[j].trim())text+='--- P√ÅG '+(j+1)+'/'+total+' ---\n'+pages[j]+'\n\n'}

    // Truncate if too long (Claude max ~200k tokens)
    if(text.length>200000) text=text.substring(0,200000)+'\n[TRUNCADO - PDF muito grande]';

    setProgress(45,'Enviando para Claude analisar (pode levar at√© 1 min)...');

    var resp=await fetch('/api/analyze',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        system:SYSTEM_PROMPT,
        fileName:currentFile.name,
        text:text
      })
    });

    setProgress(85,'Processando resposta...');
    if(!resp.ok){
      var errData;
      try{errData=await resp.json()}catch(e){errData={error:'Erro '+resp.status}}
      throw new Error(errData.error?.message||errData.error||'Erro '+resp.status);
    }
    var data=await resp.json();
    var raw=data.content.map(function(c){return c.text||''}).join('');
    var parsed;
    try{parsed=JSON.parse(raw.replace(/```json\s*/g,'').replace(/```/g,'').trim())}
    catch(ex){var m=raw.match(/\{[\s\S]*\}/);parsed=m?JSON.parse(m[0]):null}
    if(!parsed)throw new Error('Resposta inv√°lida do Claude.');

    analysisResults=parsed;setProgress(100,'Conclu√≠do!');
    renderResults(parsed);show($('resultsSection'));
    $('headerStatus').textContent='‚úÖ An√°lise conclu√≠da ‚Äî '+total+' p√°ginas';
    $('footerNote').textContent='An√°lise gerada por Claude AI ¬∑ '+new Date().toLocaleDateString('pt-BR');show($('footerNote'));
    setTimeout(function(){$('resultsSection').scrollIntoView({behavior:'smooth'})},300);
  }catch(err){showError(err.message)}
  finally{hide($('progressSection'));btn.disabled=false;btn.textContent='ANALISAR PROCESSO'}
}

function renderResults(data){
  var wrap=$('resultsWrap');wrap.innerHTML='';
  FIELDS.forEach(function(field,i){
    var div=document.createElement('div');
    if(field.cat){div.className='cat-row';div.textContent=field.cat}
    else{var val=data[field.key]||'N/A';var empty=isEmpty(val);div.className='data-row';div.style.animationDelay=(i*0.03)+'s';div.innerHTML='<div class="data-label">'+field.label+'</div><div class="data-value'+(empty?' empty':'')+'">' +escapeHtml(val)+'</div>'}
    wrap.appendChild(div);
  });
}

function exportCSV(){
  if(!analysisResults)return;
  var rows=FIELDS.filter(function(f){return f.key}).map(function(f){return '"'+f.label+'","'+(analysisResults[f.key]||'N/A').replace(/"/g,'""')+'"'});
  var blob=new Blob(['\uFEFF'+'Campo,Valor\n'+rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='analise_'+(currentFile?currentFile.name.replace('.pdf',''):'processo')+'.csv';a.click();
}

function resetAll(){
  currentFile=null;fileBuffer=null;analysisResults=null;
  show($('uploadZone'));show($('uploadFooter'));
  hide($('analyzeSection'));hide($('resultsSection'));hide($('resetSection'));hide($('footerNote'));hide($('errorBox'));
  $('headerStatus').classList.remove('visible');$('uploadZone').style.borderColor='';
  $('fileName').textContent='Aceita qualquer PDF trabalhista ‚Äî qualquer tamanho';$('fileInput').value='';
}

function escapeHtml(str){var div=document.createElement('div');div.textContent=String(str);return div.innerHTML}
</script>
</body>
</html>
